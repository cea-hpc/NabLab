/*******************************************************************************
 * Copyright (c) 2018 CEA
 * This program and the accompanying materials are made available under the 
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0.
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 * 	Benoit Lelandais - initial implementation
 * 	Marie-Pierre Oudot - initial implementation
 * 	Jean-Sylvain Camier - Nabla generation support
 *******************************************************************************/
module Height;

connectivities {
	cells: (âˆ…) â†’ {cell};
	outerSouthCells: (âˆ…) â†’ {cell};
	outerNorthCells: (âˆ…) â†’ {cell};
	outerEastCells: (âˆ…) â†’ {cell};
	outerWestCells: (âˆ…) â†’ {cell};
	upCell: (cell) â†’ cell;
	downCell: (cell) â†’ cell;
	leftCell: (cell) â†’ cell;
	rightCell: (cell) â†’ cell;
}

const â„• MAX_INLET_NB 			= 9201;
const â„¾ option_fill				= false;

â„ hn[cells];					// deja dans depth
â„ h[cells], hnp[cells];			// height
â„ inlet[MAX_INLET_NB];


IniOuterWestHn: âˆ€jâˆˆouterWestCells(), hn{j} = inlet{0};
IniInnerHn: âˆ€jâˆˆcells(), if (option_fill) { hn{j} = refill(uid); }

âˆ€ outer ~west cells outerNotWestCellsHeight @ -13 { âˆ€ outer south face hn=hn[â†‘]; }
âˆ€ outer ~west cells @ -13 { âˆ€ outer north faces hn=hn[â†“]; }
âˆ€ outer ~west cells @ -11 { âˆ€ outer east faces hn=hn[â†]; }
âˆ€ outer ~west cells @ -11 { âˆ€ outer west faces hn=hn[â†’]; }

/*âˆ€ cells @ -11 {
  if (uid==0) printf("\n[33m[height ini] hn:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",hn);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

iniHMax @ -17 { hmax=-âˆž;}
âˆ€ inner cells @ -9 { hmax = fmax(hn,hmax); }
iniMaxWaterHeight @ -7 { hmax0=fmax(hmax,hmax_bound);}

// ***************************************************************************
// * Compute loop
// ***************************************************************************
iniHmax @ 0 { hmax=-âˆž; }
âˆ€ inner cells @ 1 { hmax = fmax(hn,hmax); }

/*âˆ€ cells @ 1 {
  if (uid==0) printf("\n[33m[height] hn:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",hn);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

âˆ€ inner cells @ 1.2 {
  const â„ dhr=(un>0.0)?d_hn:d_hn[â†’];
  const â„ dhl=(un[â†]>0.0)?d_hn[â†]:d_hn;
  deqh_dx = (un*dhr-un[â†]*dhl)*inv_dx;
}

/*âˆ€ cells @ 1.23 {
  if (uid==0) printf("\n[33m[deqh_dx] deqh_dx:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",deqh_dx);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

âˆ€ inner cells @ 1.2 {
  const â„ dhu=(vn>0.0)?d_hn:d_hn[â†‘];
  const â„ dhd=(vn[â†“]>0.0)?d_hn[â†“]:d_hn;
  deqh_dy = (vn*dhu-vn[â†“]*dhd)*inv_dy;
}

/*âˆ€ cells @ 1.23 {
  if (uid==0) printf("\n[33m[deqh_dy] deqh_dy:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",deqh_dy);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

âˆ€ inner cells @ 1.21 { deqh = deqh_dx + deqh_dy; }

âˆ€ outer cells @ 1.22 { hnp = hn; }
âˆ€ inner cells @ 1.23 { hnp = hn - Î´t*deqh; }


âˆ€ inner cells @ 1.3 { hn = hnp; }


// ***************************************************************************
// * HN read INLETs
// ***************************************************************************
âˆ€ outer west cells @ 7.0 { // Lecture et application des inlet Ã  l'ouest
  //info()<<"[outer west cells]  Lecture et application des inlet Ã  l'ouest, iteration="<<iteration;
  hn=inlet[(iteration-1)%MAX_INLET_NB];
}
//loopHnFill6 @ 7.1 if (option_fill) { fill(hn); }
âˆ€ cells @ 7.1 if (option_fill) { hn=refill(uid); }

// ***************************************************************************
// * HN Boundaries
// ***************************************************************************
âˆ€ outer ~west cells @ 7.2 { âˆ€ outer south face hn=hn[â†‘]; }
âˆ€ outer ~west cells @ 7.2 { âˆ€ outer north face hn=hn[â†“]; }
âˆ€ outer ~west cells @ 7.2 { âˆ€ outer east faces hn=hn[â†]; }
âˆ€ outer ~west cells @ 7.2 { âˆ€ outer west faces hn=hn[â†’]; }

// ***************************************************************************
// * H for output
// ***************************************************************************
IniH: âˆ€jâˆˆcells(), h{j} = hn{j};
IniOuterSouthH: âˆ€jâˆˆouterSouthCells(), h{j} = -hn{upCell(j)};
IniOuterNorthH: âˆ€jâˆˆouterNorthCells(), h{j} = -hn{downCell(j)};
IniOuterEastH:  âˆ€jâˆˆouterEastCells(),  h{j} = -hn{leftCell(j)};
IniOuterWestH:  âˆ€jâˆˆouterWestCells(),  h{j} = -hn{rightCell(j)};

