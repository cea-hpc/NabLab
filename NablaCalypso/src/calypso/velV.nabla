/*******************************************************************************
 * Copyright (c) 2018 CEA
 * This program and the accompanying materials are made available under the 
 * terms of the Eclipse Public License 2.0 which is available at
 * http://www.eclipse.org/legal/epl-2.0.
 *
 * SPDX-License-Identifier: EPL-2.0
 *
 * Contributors:
 * 	Benoit Lelandais - initial implementation
 * 	Marie-Pierre Oudot - initial implementation
 * 	Jean-Sylvain Camier - Nabla generation support
 *******************************************************************************/
module VelV;

with Math.*;
with Calypso.*;

connectivities {
	cells: (âˆ…) â†’ {cell};
}

// ****************************************************************************
// * Options
// ****************************************************************************
const â„¾ option_fill				= false;

// ****************************************************************************
// * Cells
// ****************************************************************************
â„ x[cells], dx[cells];
â„ y[cells], dy[cells];
â„ z[cells], d[cells], d_hn[cells];	// depth
â„ h[cells], hn[cells], hnp[cells];	// height
â„ un[cells], unp[cells];			// velocity X
â„ vn[cells], vnp[cells];   			// velocity Y

//iniVnFill6 @ -8.8 if (option_fill) { fill(vn); }
IniVnFill: âˆ€jâˆˆcells(), if (option_fill) { vn=refill(uid); }

âˆ€ outer cells @ -8.7 { âˆ€ outer west faces vn=vn[â†’]; }
âˆ€ outer cells @ -8.7 { âˆ€ outer east faces vn=vn[â†]; }

âˆ€ outer south cells @ -8.7 { vn=0.0; }
âˆ€ outer north cells @ -8.7 { vn=0.0; }
âˆ€ inner north cells @ -8.7 { vn=0.0; }

/*âˆ€ cells @ -8.7 {
  if (uid==0) printf("\n[33m[V ini] vn:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",vn);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

âˆ€ inner cells nlsw1_eqV @ -3.4 {
  const â„ tu = Â¼*(un[â†]+un+un[â†–]+un[â†‘]);
  const â„ vl = (tu>0)?vn:vn[â†’];
  const â„ vr = (tu>0)?vn[â†]:vn;
  const â„ vu = (vn>0)?vn:vn[â†‘];
  const â„ vd = (vn>0)?vn[â†“]:vn;
  const â„ tv1 = tu*(vl-vr);
  const â„ tv2 = vn*(vu-vd);
  const â„ thv = GZ*(hn[â†‘]-hn);
  const â„ tfc = tu*fc;
  const â„ deqv = tv1*inv_dx + (tv2+thv)*inv_dy + tfc;
  vnp = vn - Â½*Î´t*deqv;
}

âˆ€ inner north cells @ -3.35 { vnp=0.0; }

/*âˆ€ cells @ -3.35 {
  if (uid==0) printf("\n[33m[Vnp ini] vnp:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",vnp);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/

iniVMinMax @ -4.0 { vmin=+âˆ; vmax=-âˆ;}
âˆ€ inner cells @ -3.9{
  vmin = fmin(vn,vmin);
  vmax = fmax(vn,vmax);
}

âˆ€ inner cells ini_update_vn @ -3 { vn = vnp; }


// ***************************************************************************
// * Compute loop
// ***************************************************************************

âˆ€ outer cells @ 2.0 { vnp=0.0; }

âˆ€ inner cells @ 2.0 {
  const â„ tu = Â¼*(un[â†]+un+un[â†–]+un[â†‘]);
  const â„ vl = (tu>0.0)?vn:vn[â†’];
  const â„ vr = (tu>0.0)?vn[â†]:vn;
  const â„ vu = (vn>0.0)?vn:vn[â†‘];
  const â„ vd = (vn>0.0)?vn[â†“]:vn;
  const â„ tv1 = tu*(vl-vr);
  const â„ tv2 = vn*(vu-vd);
  const â„ thv = GZ*(hn[â†‘]-hn);
  const â„ tfc = tu*fc;
  const â„ deqv = tv1*inv_dx + (tv2+thv)*inv_dy + tfc;
  vnp = vn - Î´t*deqv;
}

//âˆ€ inner north cells @ 2.1 { vnp=0.0; }

âˆ€ inner cells @ 2.2 { // Runup
  const â„ Îµ = option_epsd;
  const â„ coef_grad_h = coef_grady_h;
  const â„¾ dorh = d_hn[â†‘]<Îµ or hn[â†‘]<-d;
  const â„¾ vorh = vnp<0.0 and hn[â†‘]>hn;
  vnp=(d_hn<Îµ and dorh)?0.0:(d_hn<Îµ and vorh)?vnp-coef_grad_h*(hn+d[â†‘]):vnp;
  if (d_hn[â†‘] < Îµ){
    if (hn < -d[â†‘]) vnp = 0.0;
    if (vnp>0.0 and hn>hn[â†‘]) vnp += coef_grad_h*(hn[â†‘]+d);
    continue;
  }
  if (vnp>0.0){
    if (-d>hn[â†‘]) vnp += coef_grad_h*(hn[â†‘]+d);
    if (-d[â†‘]>hn) vnp -= coef_grad_h*(hn+d[â†‘]);
  }
}

âˆ€ inner cells @ 3 { vn = vnp; }

// ***************************************************************************
// * VN Boundaries
// ***************************************************************************
âˆ€ outer cells @ 7.2 { âˆ€ outer west faces vn=vn[â†’]; }
âˆ€ outer cells @ 7.2 { âˆ€ outer east faces vn=vn[â†]; }

//âˆ€ outer south cells @ 7.2 { vn=0.0; }
âˆ€ outer north cells @ 7.2 { vn=0.0; }
âˆ€ inner north cells @ 7.2 { vn=0.0; }

/*âˆ€ cells @ 7.3 {
  if (uid==0) printf("\n[33m[Vn Boundaries] vn:[m");
  if ((uid%X_EDGE_ELEMS)==0) printf("\n");
  printf(" %.12f",vn);
  if (uid==(X_EDGE_ELEMS*Y_EDGE_ELEMS-1)) printf("\n[m");
  }*/